---
import Layout from '../../layouts/Layout.astro';
import { fetchProducts } from '../../lib/airtable';

// Generate static paths for all products
export async function getStaticPaths() {
	const products = await fetchProducts();
	return products.map((product) => ({
		params: { id: product.id },
		props: { product },
	}));
}

const { product } = Astro.props;

if (!product) {
	return Astro.redirect('/404');
}

const allProducts = await fetchProducts();
const relatedProducts = allProducts
	.filter((p) => p.id !== product.id && p.category === product.category && p.inStock)
	.slice(0, 3);

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('it-IT', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<Layout title={`${product.name} - Denif`}>
	<section class="py-8 md:py-12">
		<div class="container mx-auto px-4 sm:px-6 lg:px-8">
			<!-- Breadcrumb -->
			<nav class="mb-8 text-sm">
				<ol class="flex items-center space-x-2 text-neutral-600">
					<li><a href="/" class="hover:text-neutral-900">Home</a></li>
					<li>/</li>
					<li><a href="/catalogo" class="hover:text-neutral-900">Catalogo</a></li>
					<li>/</li>
					<li class="text-neutral-900">{product.name}</li>
				</ol>
			</nav>

			<!-- Product Details -->
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 mb-16">
				<!-- Images -->
				<div class="space-y-4">
					<div class="aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden">
						<img
							src={product.images[0] || '/placeholder-product.jpg'}
							alt={product.name}
							class="w-full h-full object-cover"
							id="main-image"
						/>
					</div>
					{product.images.length > 1 && (
						<div class="grid grid-cols-4 gap-4">
							{product.images.map((img, i) => (
								<button
									class={`aspect-square bg-neutral-100 rounded-md overflow-hidden border-2 transition-colors ${
										i === 0 ? 'border-neutral-900' : 'border-transparent hover:border-neutral-300'
									}`}
									data-image={img}
									data-index={i}
								>
									<img
										src={img}
										alt={`${product.name} - Vista ${i + 1}`}
										class="w-full h-full object-cover"
									/>
								</button>
							))}
						</div>
					)}
				</div>

				<!-- Product Info -->
				<div class="space-y-6">
					<div>
						<span class="inline-block px-3 py-1 bg-neutral-100 text-neutral-700 text-sm rounded-full mb-3">
							{product.category}
						</span>
						<h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2">
							{product.name}
						</h1>
						<p class="text-3xl font-semibold text-neutral-900">
							{formatPrice(product.price)}
						</p>
					</div>

					<p class="text-neutral-600 leading-relaxed">
						{product.description}
					</p>

					{product.inStock ? (
						<>
							<!-- Size Selector -->
							<div>
								<label class="block text-sm font-medium mb-3">
									Taglia <span class="text-neutral-500">(obbligatoria)</span>
								</label>
								<div id="size-selector" class="flex flex-wrap gap-2">
									{product.sizes.map((size) => (
										<button
											data-size={size}
											class="size-option px-4 py-2 border border-neutral-300 rounded-md hover:border-neutral-900 transition-colors text-sm font-medium"
										>
											{size}
										</button>
									))}
								</div>
								<p id="size-error" class="hidden mt-2 text-sm text-red-600">
									Seleziona una taglia
								</p>
							</div>

							<!-- Add to Cart Button -->
							<button
								id="add-to-cart"
								disabled
								class="w-full px-6 py-4 bg-neutral-900 text-white font-medium rounded-md hover:bg-neutral-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
							>
								Aggiungi al Carrello
							</button>

							<p class="text-sm text-neutral-500 text-center">
								Spedizione in 3-5 giorni lavorativi
							</p>
						</>
					) : (
						<div class="px-4 py-3 bg-neutral-100 text-neutral-700 rounded-md text-center">
							Attualmente non disponibile
						</div>
					)}

					<!-- Features -->
					<div class="border-t border-neutral-200 pt-6 space-y-3">
						<div class="flex items-start space-x-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-neutral-700 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
							</svg>
							<span class="text-sm text-neutral-600">Fatto a mano in Italia</span>
						</div>
						<div class="flex items-start space-x-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-neutral-700 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<circle cx="12" cy="12" r="10"/>
								<path d="M12 6v6l4 2"/>
							</svg>
							<span class="text-sm text-neutral-600">Pelle italiana di prima qualit√†</span>
						</div>
						<div class="flex items-start space-x-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-neutral-700 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
							</svg>
							<span class="text-sm text-neutral-600">Suola in cuoio toscano</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Related Products -->
			{relatedProducts.length > 0 && (
				<section class="border-t border-neutral-200 pt-12">
					<h2 class="text-2xl font-bold tracking-tight mb-6">Potrebbero piacerti</h2>
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
						{relatedProducts.map((p) => (
							<a
								href={`/prodotto/${p.id}`}
								class="group relative bg-white border border-neutral-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow"
							>
								<div class="aspect-[4/3] overflow-hidden bg-neutral-100">
									<img
										src={p.images[0] || '/placeholder-product.jpg'}
										alt={p.name}
										class="h-full w-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
										loading="lazy"
									/>
								</div>
								<div class="p-4">
									<h3 class="font-medium text-neutral-900 group-hover:text-neutral-600 transition-colors">
										{p.name}
									</h3>
									<p class="text-lg font-semibold mt-1">{formatPrice(p.price)}</p>
								</div>
							</a>
						))}
					</div>
				</section>
			)}
		</div>
	</section>
</Layout>

<script define:vars={{ product }}>
	let selectedSize = '';

	// Image gallery
	const mainImage = document.getElementById('main-image') as HTMLImageElement;
	const thumbnailButtons = document.querySelectorAll('[data-image]');

	thumbnailButtons.forEach((btn) => {
		btn.addEventListener('click', () => {
			const img = btn.getAttribute('data-image');
			if (img && mainImage) {
				mainImage.src = img;
			}

			// Update active state
			thumbnailButtons.forEach((b) => {
				b.classList.remove('border-neutral-900');
				b.classList.add('border-transparent');
			});
			btn.classList.remove('border-transparent');
			btn.classList.add('border-neutral-900');
		});
	});

	// Size selector
	const sizeOptions = document.querySelectorAll('.size-option');
	const addToCartButton = document.getElementById('add-to-cart') as HTMLButtonElement;
	const sizeError = document.getElementById('size-error');

	sizeOptions.forEach((option) => {
		option.addEventListener('click', () => {
			const size = option.getAttribute('data-size') || '';
			selectedSize = size;

			// Update UI
			sizeOptions.forEach((opt) => {
				opt.classList.remove('border-neutral-900', 'bg-neutral-900', 'text-white');
				opt.classList.add('border-neutral-300');
			});
			option.classList.remove('border-neutral-300');
			option.classList.add('border-neutral-900', 'bg-neutral-900', 'text-white');

			// Enable add to cart button
			addToCartButton.disabled = false;
			sizeError?.classList.add('hidden');
		});
	});

	// Add to cart
	addToCartButton?.addEventListener('click', () => {
		if (!selectedSize) {
			sizeError?.classList.remove('hidden');
			return;
		}

		const item = {
			id: product.id,
			name: product.name,
			price: product.price,
			image: product.images[0] || '/placeholder-product.jpg',
			size: selectedSize
		};

		if ((window as any).addToCart) {
			(window as any).addToCart(item);
		}
	});
</script>
