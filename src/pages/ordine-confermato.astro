---
import Layout from '../layouts/Layout.astro';

// Get order ID from URL params
const orderId = Astro.url.searchParams.get('orderId') || '';
const title = 'Ordine Confermato - DENIF';
const description = 'Il tuo ordine è stato confermato con successo';
---

<Layout title={title} description={description}>
	<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
		{/* Loading State */}
		<div id="loading" class="text-center py-12">
			<svg class="animate-spin h-12 w-12 text-neutral-900 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
				<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
				<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
			</svg>
			<p class="text-neutral-600">Caricamento ordine...</p>
		</div>

		{/* Order Not Found */}
		<div id="order-not-found" class="hidden text-center py-12">
			<svg class="w-16 h-16 text-neutral-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
			</svg>
			<h2 class="text-2xl font-semibold mb-2" style="font-family: var(--font-display)">
				Ordine non trovato
			</h2>
			<p class="text-neutral-600 mb-6">
				Non siamo riusciti a trovare l'ordine specificato.
			</p>
			<a
				href="/catalogo"
				class="inline-block bg-neutral-900 text-white px-6 py-3 rounded-md font-medium hover:bg-neutral-800 transition-colors"
			>
				Vai al Catalogo
			</a>
		</div>

		<!-- Order Confirmation Content -->
		<div id="confirmation-content" class="hidden max-w-3xl mx-auto">
			<!-- Success Animation -->
			<div class="text-center mb-8">
				<div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4 animate-bounce">
					<svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
					</svg>
				</div>
				<h1 class="text-3xl font-semibold mb-2" style="font-family: var(--font-display)">
					Ordine Confermato!
				</h1>
				<p class="text-neutral-600">
					Grazie per il tuo acquisto. Ti abbiamo inviato una email di conferma.
				</p>
			</div>

			<!-- Order Details Card -->
			<div class="bg-white border border-neutral-200 rounded-lg p-6 mb-6">
				<div class="flex items-start justify-between mb-6">
					<div>
						<h2 class="text-xl font-semibold mb-1" style="font-family: var(--font-display)">
							Ordine <span id="order-id" class="text-neutral-900"></span>
						</h2>
						<p class="text-sm text-neutral-500">
							Data: <span id="order-date"></span>
						</p>
					</div>
					<span id="order-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
						Confermato
					</span>
				</div>

				<!-- Customer Information -->
				<div class="border-t border-neutral-200 pt-6 mb-6">
					<h3 class="font-semibold mb-3">Informazioni di Spedizione</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
						<div>
							<p class="text-neutral-500">Cliente</p>
							<p id="customer-name" class="font-medium"></p>
						</div>
						<div>
							<p class="text-neutral-500">Email</p>
							<p id="customer-email" class="font-medium"></p>
						</div>
						<div>
							<p class="text-neutral-500">Telefono</p>
							<p id="customer-phone" class="font-medium"></p>
						</div>
						<div>
							<p class="text-neutral-500">Indirizzo</p>
							<p id="customer-address" class="font-medium"></p>
						</div>
					</div>
				</div>

				<!-- Order Items -->
				<div class="border-t border-neutral-200 pt-6 mb-6">
					<h3 class="font-semibold mb-3">Prodotti Ordinati</h3>
					<div id="order-items" class="space-y-4">
						<!-- Items will be rendered here -->
					</div>
				</div>

				<!-- Order Totals -->
				<div class="border-t border-neutral-200 pt-6">
					<div class="space-y-2 text-sm">
						<div class="flex justify-between">
							<span class="text-neutral-600">Subtotale</span>
							<span id="order-subtotal" class="font-medium"></span>
						</div>
						<div class="flex justify-between">
							<span class="text-neutral-600">Spedizione</span>
							<span id="order-shipping" class="font-medium"></span>
						</div>
						<div class="flex justify-between text-lg font-semibold pt-2 border-t border-neutral-200">
							<span>Totale</span>
							<span id="order-total" class="text-neutral-900"></span>
						</div>
					</div>
				</div>
			</div>

			<!-- Delivery Estimate -->
			<div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
				<div class="flex items-start space-x-3">
					<svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
						<path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
						<path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" />
					</svg>
					<div>
						<h3 class="font-semibold text-blue-900">Consegna Stimata</h3>
						<p id="delivery-date" class="text-blue-800 font-medium"></p>
						<p class="text-sm text-blue-600 mt-1">Riceverai una email quando il tuo ordine sarà spedito</p>
					</div>
				</div>
			</div>

			<!-- Payment Info -->
			<div class="bg-neutral-50 border border-neutral-200 rounded-lg p-6 mb-6">
				<div class="flex items-start space-x-3">
					<svg class="w-6 h-6 text-neutral-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
					</svg>
					<div>
						<h3 class="font-semibold">Pagamento</h3>
						<p id="payment-method" class="text-sm text-neutral-600 mt-1"></p>
						<p id="transaction-id" class="text-xs text-neutral-500 mt-1"></p>
					</div>
				</div>
			</div>

			<!-- Action Buttons -->
			<div class="flex flex-col sm:flex-row gap-4 justify-center">
				<a
					href="/catalogo"
					class="inline-flex items-center justify-center px-6 py-3 border border-neutral-300 rounded-md font-medium text-neutral-700 hover:bg-neutral-50 transition-colors"
				>
					<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
					</svg>
					Continua lo Shopping
				</a>
				<a
					href="/ordini"
					class="inline-flex items-center justify-center px-6 py-3 bg-neutral-900 text-white rounded-md font-medium hover:bg-neutral-800 transition-colors"
				>
					<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
					</svg>
					Vedi i Miei Ordini
				</a>
			</div>
		</div>
	</div>
</Layout>

<script>
	// Get order ID from URL
	const urlParams = new URLSearchParams(window.location.search);
	const orderId = urlParams.get('orderId');

	// Load order details
	async function loadOrder() {
		if (!orderId) {
			showOrderNotFound();
			return;
		}

		try {
			const { getOrderById } = await import('../lib/order-storage');
			const order = getOrderById(orderId);

			if (!order) {
				showOrderNotFound();
				return;
			}

			displayOrder(order);
		} catch (error) {
			console.error('Error loading order:', error);
			showOrderNotFound();
		}
	}

	function showOrderNotFound() {
		document.getElementById('loading')?.classList.add('hidden');
		document.getElementById('order-not-found')?.classList.remove('hidden');
	}

	function displayOrder(order: any) {
		// Hide loading
		document.getElementById('loading')?.classList.add('hidden');

		// Show content
		const content = document.getElementById('confirmation-content');
		if (content) {
			content.classList.remove('hidden');
		}

		// Order ID
		const orderIdEl = document.getElementById('order-id');
		if (orderIdEl) {
			orderIdEl.textContent = order.orderId;
		}

		// Order Date
		const orderDateEl = document.getElementById('order-date');
		if (orderDateEl) {
			const date = new Date(order.createdAt);
			orderDateEl.textContent = date.toLocaleDateString('it-IT', {
				year: 'numeric',
				month: 'long',
				day: 'numeric',
			});
		}

		// Customer Information
		const customerName = document.getElementById('customer-name');
		if (customerName) {
			customerName.textContent = `${order.customer.firstName} ${order.customer.lastName}`;
		}

		const customerEmail = document.getElementById('customer-email');
		if (customerEmail) {
			customerEmail.textContent = order.customer.email;
		}

		const customerPhone = document.getElementById('customer-phone');
		if (customerPhone) {
			customerPhone.textContent = order.customer.phone;
		}

		const customerAddress = document.getElementById('customer-address');
		if (customerAddress) {
			customerAddress.textContent = `${order.customer.address}, ${order.customer.city} ${order.customer.postalCode}, ${order.customer.country}`;
		}

		// Order Items
		const itemsContainer = document.getElementById('order-items');
		if (itemsContainer) {
			itemsContainer.innerHTML = order.items.map((item: any) => `
				<div class="flex items-center space-x-4">
					<img
						src="${item.image}"
						alt="${item.name}"
						class="w-16 h-16 object-cover rounded-md border border-neutral-200"
					/>
					<div class="flex-1">
						<h4 class="font-medium">${item.name}</h4>
						<p class="text-sm text-neutral-500">Taglia: ${item.size} | Qtà: ${item.quantity}</p>
					</div>
					<p class="font-medium">€${item.subtotal.toFixed(2)}</p>
				</div>
			`).join('');
		}

		// Totals
		const subtotalEl = document.getElementById('order-subtotal');
		if (subtotalEl) {
			subtotalEl.textContent = `€${order.totals.subtotal.toFixed(2)}`;
		}

		const shippingEl = document.getElementById('order-shipping');
		if (shippingEl) {
			shippingEl.textContent = order.totals.shipping === 0
				? 'Gratis'
				: `€${order.totals.shipping.toFixed(2)}`;
		}

		const totalEl = document.getElementById('order-total');
		if (totalEl) {
			totalEl.textContent = `€${order.totals.total.toFixed(2)}`;
		}

		// Delivery Date
		const deliveryDateEl = document.getElementById('delivery-date');
		if (deliveryDateEl && order.estimatedDelivery) {
			const date = new Date(order.estimatedDelivery);
			deliveryDateEl.textContent = `Entro il ${date.toLocaleDateString('it-IT', {
				weekday: 'long',
				year: 'numeric',
				month: 'long',
				day: 'numeric',
			})}`;
		}

		// Payment Info
		const paymentMethodEl = document.getElementById('payment-method');
		if (paymentMethodEl) {
			const methodNames = {
				'card': 'Carta di Credito/Debito',
				'paypal': 'PayPal',
				'bank-transfer': 'Bonifico Bancario'
			};
			paymentMethodEl.textContent = methodNames[order.payment.method as keyof typeof methodNames] || order.payment.method;
		}

		const transactionIdEl = document.getElementById('transaction-id');
		if (transactionIdEl && order.payment.transactionId) {
			transactionIdEl.textContent = `ID Transazione: ${order.payment.transactionId}`;
		}
	}

	// Initialize on page load
	document.addEventListener('DOMContentLoaded', loadOrder);
</script>
